# プロジェクトファイル構造と役割

*** 更新日: 2025年10月14日 ***

このドキュメントは、`Munition_AutoPatcher_v1.1` プロジェクトの主要なファイルとディレクトリの構造、およびそれぞれの役割を解説します。

---

## 主要なファイルとディレクトリの役割

### 1. ルートディレクトリ (`/`)

アプリケーションの実行と設定に関連する主要なファイルが配置されています。

-   `AutoPatcherGUI.py`
    -   **役割**: GUIアプリケーションのメインファイル。ユーザーが操作するインターフェースを提供し、ここから全ての自動処理が開始されます。
-   `Orchestrator.py`
    -   **役割**: 自動処理全体の流れを制御する「司令塔」。xEditの実行、中間ファイルの収集、`mapper.py`の呼び出し、最終的なINI生成まで、一連のタスクを統括します。
-   `mapper.py`
    -   **役割**: MODで追加されたカスタム弾薬を、Munitionsの弾薬に手動でマッピングするためのGUIツール。`Orchestrator.py`から呼び出されます。
-   `robco_ini_generate.py`
    -   **役割**: `strategy.json`や`ammo_map.ini`などの入力ファイルに基づき、RobCo Patcherが使用する最終的な`.ini`パッチファイルを生成します。
-   `config.ini`
    -   **役割**: アプリケーションの動作に必要なパス（xEdit実行ファイル、ゲームのDataフォルダなど）や、MO2連携設定などを定義します。

### 2. `pas_scripts/`

xEdit (Pascal) スクリプトが格納されています。これらのスクリプトは、ゲームのプラグインファイルから情報を抽出する役割を担います。

-   `00_RunAllExtractors.pas`
    -   **役割**: xEditから実行される唯一のエントリーポイント。他の全ての抽出スクリプトを順番に呼び出します。
-   `AutoPatcherCore.pas`
    -   **役割**: Pascalスクリプト群のコアAPI。抽出処理の本体（`AP_Run_...`関数）を定義します。
-   `ExtractWeaponAmmoMappingLogic.pas` / `ExportLeveledListsLogic.pas`
    -   **役割**: 特定のデータ（武器と弾薬の関連、レベルドリストなど）を抽出するための具体的なロジックが実装されています。
-   `lib/AutoPatcherLib.pas`
    -   **役割**: FormIDの解決やログ出力、ファイル保存など、複数のPascalスクリプトで共有される汎用ライブラリです。

### 3. `Output/`

xEditスクリプトが実行されることで生成される中間ファイルが保存されるディレクトリです。これらのファイルは、後続のPythonスクリプトによって処理されます。

-   `weapon_omod_map.json`: 武器、弾薬、OMODの関連情報。
-   `munitions_ammo_ids.ini`: Munitions弾薬の一覧。
-   `unique_ammo_for_mapping.ini`: `mapper.py`の入力となる未マッピングの弾薬リスト。
-   `WeaponLeveledLists_Export.csv`: 武器が配布されるレベルドリストの一覧。

*(注: xEditの環境設定によっては、これらのファイルが `xedit_edit_scripts_output/` に生成される場合もあります)*

### 4. `RobCo_Auto_Patcher/`

最終的に生成されたRobCo Patcher用のパッチファイル（`.ini`）が格納されるディレクトリです。このディレクトリ構造は、そのままMODとして配布可能な形式になっています。

-   `F4SE/Plugins/RobCo_Patcher/`
    -   `formlist/`: フォームリストを変更するINIファイルが格納されます。
    -   `weapon/`: 武器の弾薬を変更するINIファイルが格納されます。
    -   `omod/`: 武器MODの弾薬を変更するINIファイルが格納されます。
-   `RobCo_Auto_Patcher.zip` (ルートディレクトリに生成)
    -   **役割**: 上記の`RobCo_Auto_Patcher`ディレクトリを圧縮した、配布用のZIPアーカイブです。

### 5. `Document/`

このプロジェクトに関連するドキュメントが格納されています。

-   `python_document.md`: PythonスクリプトのAPIリファレンス。
-   `pascal_document.md`: PascalスクリプトのAPIリファレンス。
-   `ファイル構造.md`: このファイル。プロジェクトのファイル構造を説明します。

---

2025-10-14 更新

このドキュメントはリポジトリ内の主要ファイルとフォルダの構造を示します。
下に「変更前（現状）」「変更案（推奨）」を日付とともに記載し、移動した設定ファイルについての説明を追記します。

---

■ 現在のファイル構造（スナップショット） - 変更前（2025-10-14）

- pas_scripts/
- Document/
- Output/
- xedit_edit_scripts_output/
- setting/   (※ 新設予定)
- config.ini
- strategy.json
- ammo_categories.json
- ammo_map.ini
- munitions_ammo_ids.ini
- unique_ammo_for_mapping.ini

（補足）: 実際の xEdit 出力は `xedit_edit_scripts_output/` に存在するケースがあり、従来 `config.ini` の `output_dir` は `./Output` を指していました。この不一致は運用上の混乱を招くため、設定ファイルの整理を行いました。

---

■ 変更後の推奨ファイル構造（提案、2025-10-14）

- pas_scripts/
- Document/
	- ファイル構造.md  <-- このファイル（更新済）
- Output/
- xedit_edit_scripts_output/
- setting/                <-- 新規: 設定と戦略を集約
	- strategy.json         <-- 戦略ファイルを移動
	- ammo_categories.json  <-- 弾薬カテゴリ定義を移動
	- config.ini (小規模補助) ← （オプション）追加の環境固有設定
- RobCo_Auto_Patcher/
- config.ini              <-- ルートの動作設定（project_root, paths 等）
- ammo_map.ini
- munitions_ammo_ids.ini
- unique_ammo_for_mapping.ini

※ 意図: `setting/` 以下に戦略やカテゴリ、安定して参照される設定ファイルを集約することで、運用負荷を下げ、設定の検証とバージョン管理を容易にします。

---

■ なぜこの変更を行ったか（理由）
- `strategy.json` や `ammo_categories.json` はツールの挙動を決める“設定”に近く、コードと同列のルートに置くよりも `setting/` に集約した方が分かりやすい。
- xEdit の実行結果が `xedit_edit_scripts_output/` に出る場合と `Output/` に出る場合が混在しており、`config.ini` の `output_dir` が `Output/` を参照しているとツールがファイルを見つけられないため運用ミスが発生する。

---

■ 実施済み変更
- `config.ini` を更新して、以下のように `strategy_file` と `ammo_categories_file` のデフォルトパスを `setting/` に向けました。
	- strategy_file = %(project_root)s/setting/strategy.json
	- ammo_categories_file = %(project_root)s/setting/ammo_categories.json

このため、既存の実行環境で `setting/` 下にこれらのファイルを配置することを推奨します。

---

■ 次の推奨アクション
1) リポジトリ内に `setting/` ディレクトリを作成し、`strategy.json` と `ammo_categories.json` を移動またはコピーしてください。
2) xEdit 出力先が `xedit_edit_scripts_output/` にある場合、Orchestrator や手動実行で参照する `output_dir` を `setting/` に合わせるか、Orchestrator 側で `xedit_edit_scripts_output/` を探索するオプションを有効にしてください。
3) `Document/ファイル構造.md` に本ファイルをコミットし、運用手順（どの場所に何を置くか）を README に短く追記してください。

---

■ 変更後の記録（追記: 変更完了時に更新）

2025-10-14 実施: `config.ini` を更新し、`strategy.json` と `ammo_categories.json` を `setting/` に移す設定を追加しました。

完了日時: 2025-10-14 17:35 (JST)

実施内容:
- `strategy.json` を `setting/strategy.json` にコピーしました。
- `ammo_categories.json` を `setting/ammo_categories.json` にコピーしました。

最終ファイル一覧（抜粋）:

- setting/
	- strategy.json
	- ammo_categories.json
- xedit_edit_scripts_output/
	- unique_ammo_for_mapping.ini
	- munitions_ammo_ids.ini
- Output/
	- (加工済み出力を格納するディレクトリ)

注意: 元のルートにも `strategy.json` / `ammo_categories.json` が残っています（互換のため）。将来的にはルート版を削除して `setting/` を唯一の参照先にすることを推奨します。

## 追記: Pascal スクリプトが生成するファイル一覧（参照: 2025-10-14）

下記は Pascal (xEdit) スクリプト群が実行時に出力するファイルの一覧と、それぞれの目的です。`setting/` への設定移動と併せて確認してください。

- `Output/weapon_ammo_map.json`  — 武器と弾薬のマップ（JSON）。Python 側のマッピング/修復/RobCo 生成の主要入力。
- `Output/unique_ammo_for_mapping.ini` — 未マップの弾薬一覧（INI: `[UnmappedAmmo]`）。ユーザーが手動で `ammo_map.ini` を作る際の候補リスト。
- `Output/WeaponLeveledLists_Export.csv` — 武器が含まれる可能性のある leveled lists の CSV。RobCo の formlist 追加に利用。
- `Output/munitions_ammo_ids.ini` — Munitions ESL の弾薬一覧（INI）。`ammo_categories.json` と併せて弾薬カテゴリを判定するために使用。
- `Output/weapon_ammo_details.txt` — RobCo 側で使用する武器の完全識別子（パイプ区切り）。

注: 実際の xEdit 実行環境ではこれらが `xedit_edit_scripts_output/` に出力される場合があります。ツール利用時は両ディレクトリを確認してください。

*** 作成/更新日: 2025-10-14 ***

## 追記: Python スクリプト（RobCo 生成等）が想定する入出力（追記: 2025-10-14）

Python 側は Pascal の出力ファイルを入力として使用し、RobCo 用 INI や ZIP を生成します。主な想定出力は以下の通りです。

- `RobCo_Auto_Patcher/F4SE/Plugins/RobCo_Patcher/formlist/Munitions_FormList_RemoveCustomAmmo.ini`
- `RobCo_Auto_Patcher/F4SE/Plugins/RobCo_Patcher/formlist/Munitions_FormList_AddWeaponsToLL.ini`
- `RobCo_Auto_Patcher/F4SE/Plugins/RobCo_Patcher/weapon/Munitions_Weapon_SetAmmo.ini`
- `RobCo_Auto_Patcher/F4SE/Plugins/RobCo_Patcher/omod/Munitions_OMOD_SetAmmo.ini`
- `RobCo_Auto_Patcher.zip` （プロジェクトルート直下に生成される配布用アーカイブ）

これらの出力は `config.ini` の `robco_patcher_dir` と `output_dir` の設定に基づいて書き出されます。生成日時は各 INI のヘッダに `GeneratedAt=YYYY-MM-DD HH:MM:SS` として記録されます。

*** 作成/更新日: 2025-10-14 ***